var FeaturesTree=function(n){return function(){function r(r){function f(){t.find(".jstree-node").each(function(){var r=n(this),o=r.find(".jstree-anchor"),t=JSON.parse(r.attr("data-feature")),s=r.attr("data-feature-value"),f,i,e;if(t&&t.inputType&&t.inputType.name!="CHECKBOX")if(t.inputType.name=="SINGLE_LINE_STRING"){if(!r.find(".feature-tree-textbox").length){o.find(".jstree-checkbox").hide();f="text";t.inputType.validator&&t.inputType.validator.name=="NUMERIC"&&(f="number");i=n('<input class="feature-tree-textbox" type="'+f+'" />').val(s);f=="number"?(i.attr("min",t.inputType.validator.minValue),i.attr("max",t.inputType.validator.maxValue)):t.inputType.validator&&t.inputType.validator.name=="STRING"&&(t.inputType.validator.maxLength>0&&i.attr("maxlength",t.inputType.validator.maxLength),t.inputType.validator.minLength>0&&i.attr("required","required"),t.inputType.validator.regularExpression&&i.attr("pattern",t.inputType.validator.regularExpression));i.on("input propertychange paste",function(){u(t,i.val())?(r.attr("data-feature-value",i.val()),i.removeClass("feature-tree-textbox-invalid")):i.addClass("feature-tree-textbox-invalid")});i.appendTo(r)}}else t.inputType.name=="COMBOBOX"&&(r.find(".feature-tree-combobox").length||(o.find(".jstree-checkbox").hide(),e=n('<select class="feature-tree-combobox" />'),_.each(t.inputType.itemSource.items,function(t){n("<option><\/option>").attr("value",t.value).text(t.displayText).appendTo(e)}),e.val(s).on("change",function(){r.attr("data-feature-value",e.val())}).appendTo(r)))})}t=r;t.on("ready.jstree",function(){f()}).on("redraw.jstree",function(){f()}).on("after_open.jstree",function(){f()}).on("create_node.jstree",function(){f()}).on("changed.jstree",function(r,u){if(u.node){var f;u.node.state.selected?(i(t.jstree("get_parent",u.node)),f=n.makeArray(t.jstree("get_children_dom",u.node)),t.jstree("select_node",f)):(f=n.makeArray(t.jstree("get_children_dom",u.node)),t.jstree("deselect_node",f))}}).jstree({types:{"default":{icon:"fa fa-folder tree-item-icon-color icon-lg"},file:{icon:"fa fa-file tree-item-icon-color icon-lg"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]})}function i(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&i(r)}function u(n,t){var i,r,f,u;if(!n||!n.inputType||!n.inputType.validator)return!0;if(i=n.inputType.validator,i.name=="STRING"){if(t==undefined||t==null)return i.allowNull;if(typeof t!="string"||i.minLength>0&&t.length<i.minLength||i.maxLength>0&&t.length>i.maxLength)return!1;if(i.regularExpression)return new RegExp(i.regularExpression).test(t)}else if(i.name=="NUMERIC"&&((r=parseInt(t),isNaN(r))||(f=i.minValue,f>r)||(u=i.maxValue,u>0&&r>u)))return!1;return!0}function f(){return t.find(".feature-tree-textbox-invalid").length<=0}function e(){var i=[];return t.find(".jstree-node").each(function(){var u=n(this),r=JSON.parse(u.attr("data-feature"));r.inputType&&r.inputType.name!="CHECKBOX"?i.push({name:r.name,value:u.attr("data-feature-value")}):i.push({name:r.name,value:t.jstree("is_checked",u)?"true":"false"})}),i}var t;return{init:r,getFeatureValues:e,isValid:f}}}(jQuery),EditTenantModal;(function(n){n.validator.addMethod("tenancyNameRegex",function(n,t,i){return i.test(n)},app.localize("TenantName_Regex_Description"));app.modals.CreateTenantModal=function(){var r=abp.services.app.tenant,t=null,u=new app.PasswordComplexityHelper,i;this.init=function(r){function a(){y.is(":checked")?(v.slideUp("fast"),p.removeAttr("required")):(v.slideDown("fast"),p.attr("required","required"))}var f,e,s,o,h,c,l;i=r;f=i.getModal();t=f.find("form[name=TenantInformationsForm]");t.validate({rules:{TenancyName:{tenancyNameRegex:new RegExp(t.find("input[name=TenancyName]").attr("regex"))}}});e=f.find("input[name=AdminPassword],input[name=AdminPasswordRepeat]");s=e.closest(".form-group");u.setPasswordComplexityRules(e,window.passwordComplexitySetting);n("#CreateTenant_SetRandomPassword").change(function(){n(this).is(":checked")?(s.slideUp("fast"),e.removeAttr("required")):(s.slideDown("fast"),e.attr("required","required"))});o=f.find("input[name=ConnectionString]");h=o.closest(".form-group");n("#CreateTenant_UseHostDb").change(function(){n(this).is(":checked")?(h.slideUp("fast"),o.removeAttr("required")):(h.slideDown("fast"),o.attr("required","required"))});f.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var v=f.find("input[name=SubscriptionEndDateUtc]").parent("div"),y=f.find("#CreateTenant_IsUnlimited"),p=f.find("input[name=SubscriptionEndDateUtc]");y.change(function(){a()});a();c=f.find("#EditionId");l=f.find("#CreateTenant_IsInTrialPeriod");c.change(function(){var t=n("option:selected",this).attr("data-isfree")==="True",i=n("option:selected",this).val();t?l.closest("div").slideUp("fast"):l.closest("div").slideDown("fast");i<=0?f.find(".subscription-component").slideUp("fast"):f.find(".subscription-component").slideDown("fast")});c.trigger("change")};this.save=function(){if(t.valid()){var u=t.serializeFormToObject();u.SubscriptionEndDateUtc=n("#CreateTenant_IsUnlimited").is(":visible")&&!n("#CreateTenant_IsUnlimited").is(":checked")?n(".date-time-picker").data("DateTimePicker").date().format("YYYY-MM-DDTHH:mm:ss")+"Z":null;u.SetRandomPassword&&(u.Password=null);u.UseHostDb&&(u.ConnectionString=null);i.setBusy(!0);r.createTenant(u).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));i.close();abp.event.trigger("app.createTenantModalSaved")}).always(function(){i.setBusy(!1)})}}}})(jQuery);EditTenantModal=function(n){app.modals.EditTenantModal=function(){var t,r=abp.services.app.tenant,i=null;this.init=function(r){function o(){h.is(":checked")?(s.slideUp("fast"),c.removeAttr("required")):(s.slideDown("fast"),c.attr("required","required"))}var u,f,e;t=r;u=t.getModal();i=u.find("form[name=TenantInformationsForm]");i.validate();u.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var s=u.find("input[name=SubscriptionEndDateUtc]").parent("div"),h=u.find("#CreateTenant_IsUnlimited"),c=u.find("input[name=SubscriptionEndDateUtc]");h.change(function(){o()});o();f=u.find("#EditionId");e=u.find("#EditTenant_IsInTrialPeriod");f.change(function(){var t=n("option:selected",this).attr("data-isfree")==="True",i=n("option:selected",this).val();t?e.closest("div").slideUp("fast"):e.closest("div").slideDown("fast");i<=0?u.find(".subscription-component").slideUp("fast"):u.find(".subscription-component").slideDown("fast")});f.trigger("change")};this.save=function(){if(i.valid()){var u=i.serializeFormToObject();u.SubscriptionEndDateUtc=n("#CreateTenant_IsUnlimited").is(":visible")&&!n("#CreateTenant_IsUnlimited").is(":checked")?n(".date-time-picker").data("DateTimePicker").date().format("YYYY-MM-DDTHH:mm:ss")+"Z":null;t.setBusy(!0);r.updateTenant(u).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));t.close();abp.event.trigger("app.editTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery),function(){app.modals.TenantFeaturesModal=function(){function r(){n.setBusy(!0);i.resetTenantSpecificFeatures({id:n.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully"));n.getModal().on("hidden.bs.modal",function(){n.reopen()});n.close()}).always(function(){n.setBusy(!1)})}var i=abp.services.app.tenant,n,t;this.init=function(i){n=i;t=new FeaturesTree;t.init(n.getModal().find(".feature-tree"));n.getModal().find("[data-toggle=tooltip]").tooltip();n.getModal().find(".reset-features-button").click(function(){r()})};this.save=function(){if(!t.isValid()){abp.message.warn(app.localize("InvalidFeaturesWarning"));return}n.setBusy(!0);i.updateTenantFeatures({id:n.getArgs().id,featureValues:t.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));n.close()}).always(function(){n.setBusy(!1)})}}}(),function(){$(function(){function t(){nt.ajax.reload()}function a(n){abp.message.confirm(app.localize("TenantDeleteWarningMessage",n.tenancyName),function(i){i&&e.deleteTenant({id:n.id}).done(function(){t();abp.notify.success(app.localize("SuccessfullyDeleted"))})})}var e=abp.services.app.tenant,v=$("#TenantsTable"),l=$("#TenantsTableFilter"),u=$("#TenantsFormFilter"),o=$("#TenantsTable_SubscriptionEndDateRangeActive"),s=u.find("input[name='SubscriptionEndDateRange']"),h=$("#TenantsTable_CreationDateRangeActive"),c=u.find("input[name='CreationDateRange']"),y=u.find("button[name='RefreshButton']"),p=u.find("#EditionDropdown"),f={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),"delete":abp.auth.hasPermission("Pages.Tenants.Delete")},n={creationDateStart:$.url().param("creationDateStart"),creationDateEnd:$.url().param("creationDateEnd"),subscriptionEndDateStart:$.url().param("subscriptionEndDateStart"),subscriptionEndDateEnd:$.url().param("subscriptionEndDateEnd")},i={startDate:n.subscriptionEndDateStart?moment(n.subscriptionEndDateStart):moment().startOf("day"),endDate:n.subscriptionEndDateEnd?moment(n.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},r={startDate:n.creationDateStart?moment(n.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:n.creationDateEnd?moment(n.creationDateEnd):moment().endOf("day")};s.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),i),function(n,t){i.startDate=n;i.endDate=t});c.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),r),function(n,t){r.startDate=n;r.endDate=t});var w=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),b=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),k=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),d=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),g=function(){var t=p.find(":selected").val(),n={filter:l.val(),editionId:t,editionIdSpecified:t!=="-1"};return h.prop("checked")&&(n.creationDateStart=r.startDate,n.creationDateEnd=r.endDate),o.prop("checked")&&(n.subscriptionEndDateStart=i.startDate,n.subscriptionEndDateEnd=i.endDate),n},nt=v.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:e.getTenants,inputFilter:function(){return g()}},columnDefs:[{targets:0,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{cssClass:"btn btn-xs btn-primary blue",text:'<i class="fa fa-cog"><\/i> '+app.localize("Actions")+' <span class="caret"><\/span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return f.impersonation},action:function(n){d.open({extraFilters:{tenantId:n.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:n.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(n.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return f.edit},action:function(n){b.open({id:n.record.id})}},{text:app.localize("Features"),visible:function(){return f.changeFeatures},action:function(n){k.open({id:n.record.id})}},{text:app.localize("Delete"),visible:function(){return f.delete},action:function(n){a(n.record)}},{text:app.localize("Unlock"),action:function(n){e.unlockTenantAdmin({id:n.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",n.record.name))})}}]}},{targets:1,data:"tenancyName"},{targets:2,data:"name"},{targets:3,data:"editionDisplayName"},{targets:4,data:"subscriptionEndDateUtc",render:function(n){return n?moment(n).format("L"):""}},{targets:5,data:"isActive",render:function(n){return n?'<span class="label label-success">'+app.localize("Yes")+"<\/span>":'<span class="label label-default">'+app.localize("No")+"<\/span>"}},{targets:6,data:"creationTime",render:function(n){return moment(n).format("L")}}]});$("#CreateNewTenantButton").click(function(){w.open()});$("#GetTenantsButton").click(function(n){n.preventDefault();t()});abp.event.on("app.editTenantModalSaved",function(){t(!0)});abp.event.on("app.createTenantModalSaved",function(){t(!0)});o.change(function(){s.prop("disabled",!$(this).prop("checked"))});n.subscriptionEndDateStart||n.subscriptionEndDateEnd?o.prop("checked",!0):s.prop("disabled",!0);h.change(function(){c.prop("disabled",!$(this).prop("checked"))});n.creationDateStart||n.creationDateEnd?h.prop("checked",!0):c.prop("disabled",!0);y.click(function(n){n.preventDefault();t()});l.focus()})}();